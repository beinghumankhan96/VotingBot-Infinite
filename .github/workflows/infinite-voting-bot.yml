name: ðŸš€ PROD Voting Bot v3.0

on:
  workflow_dispatch:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes

jobs:
  infinite-voting:
    runs-on: ubuntu-24.04
    timeout-minutes: 55

    env:
      BATCH_SIZE: 300
      MAX_RUNTIME: 50m

    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: â˜• Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'zulu'
        cache: maven

    - name: ðŸ”¨ Build
      run: |
        mvn clean package -DskipTests
        echo "âœ… JAR: $(ls -la target/*.jar)"

    - name: ðŸ–¥ï¸ Chromium + Xvfb
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq xvfb chromium-browser fonts-liberation \
          libasound2t64 libatk-bridge2.0-0 libatk1.0-0 libatspi2.0-0 libdrm2 \
          libgbm1 libgtk-3-0t64 libnspr4 libnss3 libxcomposite1 libxdamage1 \
          libxkbcommon0 libxrandr2 libxss1 xdg-utils libgtk-3-0 libgtk2.0-0t64
        echo "âœ… Browser stack ready"

    - name: ðŸ¤– RUN BOT
      run: |
        # Start Xvfb in background
        Xvfb :99 -screen 0 1920x1080x24 -ac -noreset > xvfb.log 2>&1 &
        XVFB_PID=$!
        echo "Xvfb PID: $XVFB_PID"
        sleep 5
        
        # Run bot with timeout and proper cleanup
        timeout 50m java -jar target/infinite-voting-bot-3.0.jar > bot-output.log 2>&1 || true
        
        # Cleanup
        kill $XVFB_PID 2>/dev/null || true
        wait $XVFB_PID 2>/dev/null || true
        
        echo "ðŸ“Š RESULTS:"
        cat voting-log.txt || echo "No votes log"
      env:
        DISPLAY: :99
        BATCH_SIZE: ${{ env.BATCH_SIZE }}
        MAX_RUNTIME: ${{ env.MAX_RUNTIME }}

    - name: ðŸ“¤ Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: votes-${{ github.run_number }}-${{ github.run_id }}
        path: |
          target/*.jar
          voting-log.txt
          bot-output.log
          xvfb.log
        retention-days: 30

    - name: ðŸ“Š Summary
      if: always()
      run: |
        if [ -f voting-log.txt ]; then
          SUCCESS_VOTES=$(grep -c "VOTE SUCCESS" voting-log.txt || echo 0)
          TOTAL_ATTEMPTS=$(grep -c "Vote #" voting-log.txt || echo 0)
          [ $TOTAL_ATTEMPTS -gt 0 ] && RATE=$((SUCCESS_VOTES * 100 / TOTAL_ATTEMPTS)) || RATE=0
          echo "âœ… SUCCESS: $SUCCESS_VOTES | ðŸ”„ ATTEMPTS: $TOTAL_ATTEMPTS | ðŸ“ˆ RATE: ${RATE}%"
          echo "## ðŸŽ¯ Voting Results" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Success | $SUCCESS_VOTES |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ Attempts | $TOTAL_ATTEMPTS |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ˆ Success Rate | ${RATE}% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Latest Logs:" >> $GITHUB_STEP_SUMMARY
          tail -20 voting-log.txt >> $GITHUB_STEP_SUMMARY
        else
          echo "No voting-log.txt found"
        fi
