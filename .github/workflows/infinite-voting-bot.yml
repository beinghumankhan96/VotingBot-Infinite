name: ðŸš€ PROD Voting Bot v3.0

on:
  workflow_dispatch:
  schedule:
    - cron: '*/15 * * * *'

jobs:
  infinite-voting:
    runs-on: ubuntu-24.04
    timeout-minutes: 55

    env:
      BATCH_SIZE: 300
      MAX_RUNTIME: 50m

    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: â˜• Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'zulu'
        cache: maven

    - name: ðŸ”¨ Build
      run: mvn clean package -DskipTests

    - name: ðŸ–¥ï¸ Chromium + Xvfb
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq xvfb chromium-browser fonts-liberation libasound2t64 libatk-bridge2.0-0 libatk1.0-0 libatspi2.0-0 libdrm2 libgbm1 libgtk-3-0t64 libgtk2.0-0t64 libnspr4 libnss3 libxcomposite1 libxdamage1 libxkbcommon0 libxrandr2 libxss1 xdg-utils

    - name: ðŸ¤– RUN BOT
      env:
        DISPLAY: :99
      run: |
        set -e
        Xvfb :99 -screen 0 1920x1080x24 -ac -noreset > xvfb.log 2>&1 &
        XVFB_PID=$!
        echo "Xvfb PID: $XVFB_PID"
        sleep 5
        timeout 50m java -jar target/*.jar > bot-output.log 2>&1 || true
        kill $XVFB_PID 2>/dev/null || true
        echo "ðŸ“Š RESULTS:"; cat voting-log.txt 2>/dev/null || echo "No votes log"

    - name: ðŸ“¤ Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: votes-${{ github.run_number }}
        path: |
          target/*.jar
          *.log
          voting-log.txt

    - name: ðŸ“Š Summary
      if: always()
      run: |
        if [ -f voting-log.txt ]; then
          SUCCESS=$(grep -c "VOTE SUCCESS" voting-log.txt || echo 0)
          TOTAL=$(grep -c "Vote #" voting-log.txt || echo 0)
          RATE=$([ $TOTAL -gt 0 ] && echo $((SUCCESS * 100 / TOTAL)) || echo 0)
          echo "âœ… $SUCCESS/$TOTAL (${RATE}%)"
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Success | $SUCCESS |" >> $GITHUB_STEP_SUMMARY
          echo "| Attempts | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "| Rate | ${RATE}% |" >> $GITHUB_STEP_SUMMARY
        fi
